import{g as J}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{K as Y}from"./chunk-6HTZNHPT-HMNXWHVt.js";import{R as N,u as Z}from"./chunk-4TC5YS65-BRAnZnco.js";import{ae as ee,ag as M,aj as se,as as te,$ as ae,ba as ie,j as e,b as B,r as b,da as le,al as ne,am as re,db as ce,q as oe,bf as de,t as D,x as P,H as xe,y as f,ai as S,z as Q,B as H,bi as K,aU as ue,G as z,o as me,bv as fe}from"./index-BfncdA6x.js";import{C as ve}from"./component-Ciqtw9jg.js";import{A as he}from"./alert-BaF7jFLp.js";var pe=ee({location_id:M(),quantity:se(M(),te().or(M()))});function G(s){const a=s.variant;return a?!!a.inventory_items.length&&a.inventory_items.length>1||a.inventory_items.length===1&&a.inventory_items[0].required_quantity>1:!1}function je({item:s,form:a,locationId:d,onQuantityChange:h}){var _,q,w,$,l,o;const{t:x}=B(),u=s.variant,g=((_=s.variant)==null?void 0:_.inventory)||[],[I,E]=b.useState(!1),m=P({control:a.control,name:"quantity"}),v=G(s),{availableQuantity:c,inStockQuantity:F}=b.useMemo(()=>{var n,t;if(!u||!d)return{};const i=(t=(n=g[0])==null?void 0:n.location_levels)==null?void 0:t.find(r=>r.location_id===d);return i?{availableQuantity:i.available_quantity,inStockQuantity:i.stocked_quantity}:{}},[u,d]),T=!v&&c&&m[`${s.id}-${(q=s.variant)==null?void 0:q.inventory[0].id}`]&&m[`${s.id}-${(w=s.variant)==null?void 0:w.inventory[0].id}`]>c,L=0,p=Math.min(J(s),c||Number.MAX_SAFE_INTEGER);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 min-w-[720px] divide-y divide-dashed rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-x-3 p-3 text-sm",children:[e.jsx("div",{className:"flex flex-1 items-center",children:e.jsxs("div",{className:"flex items-center gap-x-3",children:[T&&e.jsx(K,{className:"text-ui-fg-error"}),e.jsx(ue,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex flex-row",children:[e.jsx(z,{className:"txt-small flex",as:"span",weight:"plus",children:s.product_title}),s.variant_sku&&e.jsxs("span",{className:"text-ui-fg-subtle",children:[" ","(",s.variant_sku,")"]}),v&&e.jsx(ve,{className:"text-ui-fg-muted ml-2 overflow-visible pt-[2px]"})]}),e.jsx(z,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.title})]})]})}),e.jsxs("div",{className:me("flex flex-1 items-center gap-x-3",v?"justify-end":"justify-between"),children:[!v&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[c||"-",c&&!v&&m[`${s.id}-${($=s.variant)==null?void 0:$.inventory[0].id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",m[`${s.id}-${(l=s.variant)==null?void 0:l.inventory[0].id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:F||"-"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-row items-center gap-2",children:[e.jsx(f.Field,{control:a.control,name:v?`quantity.${s.id}-`:`quantity.${s.id}-${(o=s.variant)==null?void 0:o.inventory[0].id}`,rules:{required:!v,min:!v&&L,max:p},render:({field:i})=>e.jsx(f.Item,{children:e.jsx(f.Control,{children:e.jsx(Q,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...i,disabled:!d,onChange:n=>{var r;const t=n.target.value===""?null:Number(n.target.value);h((r=s.variant)==null?void 0:r.inventory[0],s,v,t,!0)}})})})})," ","/ ",s.quantity," ",x("fields.qty")]})]})]})]}),v&&e.jsx("div",{className:"px-4 py-2",children:e.jsxs("div",{onClick:()=>E(i=>!i),className:"flex items-center gap-x-2",children:[e.jsx(fe,{style:{transform:`rotate(${I?-90:0}deg)`},className:"text-ui-fg-muted -mt-[1px]"}),e.jsx("span",{className:"txt-small text-ui-fg-muted cursor-pointer",children:x("orders.allocateItems.consistsOf",{num:g.length})})]})}),I&&u.inventory.map((i,n)=>{const t=i.location_levels.find(j=>j.location_id===d),r=!!m[`${s.id}-${i.id}`]&&m[`${s.id}-${i.id}`]>t.available_quantity;return e.jsxs("div",{className:"txt-small flex items-center gap-x-3 p-4",children:[e.jsxs("div",{className:"flex flex-1 flex-row items-center gap-3",children:[r&&e.jsx(K,{className:"text-ui-fg-error"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle",children:i.title}),e.jsx("span",{className:"text-ui-fg-muted",children:x("orders.allocateItems.requires",{num:u.inventory_items[n].required_quantity})})]})]}),e.jsxs("div",{className:"flex flex-1 flex-row justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[(t==null?void 0:t.available_quantity)||"-",(t==null?void 0:t.available_quantity)&&m[`${s.id}-${i.id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",m[`${s.id}-${i.id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:x("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:(t==null?void 0:t.stocked_quantity)||"-"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-1 flex flex-row items-center gap-2",children:[e.jsx(f.Field,{control:a.control,name:`quantity.${s.id}-${i.id}`,rules:{required:!0,min:0,max:t==null?void 0:t.available_quantity},render:({field:j})=>e.jsx(f.Item,{children:e.jsx(f.Control,{children:e.jsx(Q,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...j,disabled:!d,onChange:k=>{const y=k.target.value===""?null:Number(k.target.value);h(i,s,v,y)}})})})}),"/"," ",s.quantity*u.inventory_items[n].required_quantity," ",x("fields.qty")]})]})]})]},i.id)})]})}function ye({order:s}){var q,w,$;const{t:a}=B(),{handleSuccess:d}=Z(),[h,x]=b.useState(!1),[u,g]=b.useState(""),{mutateAsync:I,isPending:E}=le(),m=b.useMemo(()=>s.items.filter(l=>{var o,i;return((o=l.variant)==null?void 0:o.manage_inventory)&&((i=l.variant)==null?void 0:i.inventory.length)&&l.quantity-l.detail.fulfilled_quantity>0}),[s.items]),v=b.useMemo(()=>m.filter(l=>l.variant_title.toLowerCase().includes(u)||l.product_title.toLowerCase().includes(u)),[m,u]);m.length;const c=ne({defaultValues:{location_id:"",quantity:R(m)},resolver:re(pe)}),{stock_locations:F=[]}=ce(),T=c.handleSubmit(async l=>{try{const o=Object.entries(l.quantity).filter(([t])=>!t.endsWith("-")).map(([t,r])=>[...t.split("-"),r]);if(o.some(t=>t[2]==="")){c.setError("root.quantityNotAllocated",{type:"manual",message:a("orders.allocateItems.error.quantityNotAllocated")});return}const i=o.map(([t,r,j])=>I({location_id:l.location_id,inventory_item_id:r,line_item_id:t,quantity:Number(j)}).then(()=>({success:!0,inventory_item_id:r})).catch(()=>({success:!1,inventory_item_id:r}))),n=await Promise.all(i);if(await oe.invalidateQueries({queryKey:de.details()}),d(`/orders/${s.id}`),n.some(t=>!t.success)){const t=n.filter(r=>!r.success).map(r=>r.inventory_item_id).join(", ");D.error(a("general.error"),{description:a("orders.allocateItems.toast.error",{items:t}),dismissLabel:a("actions.close")})}}catch(o){D.error(a("general.error"),{description:o.message,dismissLabel:a("actions.close")})}}),L=(l,o,i,n,t)=>{var k;let r=!1;const j=t&&i?`quantity.${o.id}-`:`quantity.${o.id}-${l.id}`;if(c.setValue(j,n),n){const y=l.location_levels.find(C=>C.location_id===p);y&&y.available_quantity<n&&(r=!0)}if(i&&!t&&c.resetField(`quantity.${o.id}-`,{defaultValue:""}),i&&t){const y=m.find(C=>C.id===o.id);(k=y.variant)==null||k.inventory_items.forEach((C,W)=>{var V;const U=n||0,A=(V=y.variant)==null?void 0:V.inventory[W];if(c.setValue(`quantity.${o.id}-${A.id}`,U*C.required_quantity),n){const O=A==null?void 0:A.location_levels.find(X=>X.location_id===p);O&&O.available_quantity<n&&(r=!0)}})}c.clearErrors("root.quantityNotAllocated"),x(r)},p=P({name:"location_id",control:c.control});b.useEffect(()=>{p&&c.setValue("quantity",R(m))},[p]);const _=($=(w=(q=c.formState.errors)==null?void 0:q.root)==null?void 0:w.quantityNotAllocated)==null?void 0:$.message;return e.jsx(N.Form,{form:c,children:e.jsxs(Y,{onSubmit:T,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(N.Header,{}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col gap-8 divide-y divide-dashed",children:[e.jsx(xe,{children:a("orders.allocateItems.title")}),e.jsxs("div",{className:"flex-1 divide-y divide-dashed pt-8",children:[e.jsx(f.Field,{control:c.control,name:"location_id",render:({field:{onChange:l,ref:o,...i}})=>e.jsxs(f.Item,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(f.Label,{children:a("fields.location")}),e.jsx(f.Hint,{children:a("orders.allocateItems.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(f.Control,{children:e.jsxs(S,{onValueChange:l,...i,children:[e.jsx(S.Trigger,{className:"bg-ui-bg-base",ref:o,children:e.jsx(S.Value,{})}),e.jsx(S.Content,{children:F.map(n=>e.jsx(S.Item,{value:n.id,children:n.name},n.id))})]})})})]}),e.jsx(f.ErrorMessage,{})]})}),e.jsxs(f.Item,{className:"mt-8 pt-8",children:[e.jsxs("div",{className:"flex flex-row items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(f.Label,{children:a("orders.allocateItems.itemsToAllocate")}),e.jsx(f.Hint,{children:a("orders.allocateItems.itemsToAllocateDesc")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(Q,{value:u,onChange:l=>g(l.target.value),placeholder:a("orders.allocateItems.search"),autoComplete:"off",type:"search"})})]}),_&&e.jsx(he,{className:"mb-4",dismissible:!0,variant:"error",children:_}),e.jsx("div",{className:"flex flex-col gap-y-1",children:v.map(l=>e.jsx(je,{form:c,item:l,locationId:p,onQuantityChange:L},l.id))})]})]})]})})})}),e.jsx(N.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(H,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx(H,{size:"small",type:"submit",isLoading:E,disabled:!p||h,children:a("orders.allocateItems.action")})]})})]})})}function R(s){const a={};return s.forEach(d=>{var x,u;const h=G(d);a[h?`${d.id}-`:`${d.id}-${(x=d.variant)==null?void 0:x.inventory[0].id}`]="",h&&((u=d.variant)==null||u.inventory.forEach(g=>{a[`${d.id}-${g.id}`]=""}))}),a}function $e(){const{id:s}=ae(),{order:a,isLoading:d,isError:h,error:x}=ie(s,{fields:"currency_code,*items,*items.variant,+items.variant.product.title,*items.variant.inventory,*items.variant.inventory.location_levels,*items.variant.inventory_items,*shipping_address"});if(h)throw x;const u=!d&&a;return e.jsx(N,{children:u&&e.jsx(ye,{order:a})})}export{$e as Component};
