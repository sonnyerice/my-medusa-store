import{u as J}from"./chunk-HFB3OQXI-BQr-MiKD.js";import{C as Q}from"./chunk-2PMSBTXI-D-bGks_a.js";import{r as D,j as e,b as U,d6 as Z,y as T,v as z,d7 as O,H as R,T as ee,w as i,I as se,Y as ae,B as X,g as re,s as le,x as K}from"./index-CzNfOyID.js";import{X as te}from"./x-mark-mini-C21_Uzye.js";import{S as p}from"./select-KO8A0rQ7.js";var P=d=>(d||[]).map(s=>{var u,j;return{id:s.id,required:s.required,field_type:s.field_type,disguised:s.disguised,attribute:s.attribute,operator:s.operator,values:s.field_type==="number"||s.operator==="eq"?typeof s.values=="object"?(u=s.values[0])==null?void 0:u.value:s.values:(j=s==null?void 0:s.values)==null?void 0:j.map(b=>b.value)}}),de=(d,s)=>{var u;return!d||!s?{}:d==="currency_code"?{value:(u=s.supported_currencies)==null?void 0:u.map(j=>j.currency_code)}:{}},ie=({form:d,identifier:s,scope:u,name:j,operator:b,fieldRule:r,attributes:m,ruleType:F})=>{const a=m==null?void 0:m.find(o=>o.value===r.attribute),{store:n,isLoading:E}=re(),C=J({queryFn:async o=>await le.admin.promotion.listRuleValues(F,a==null?void 0:a.id,{...o,...de(a==null?void 0:a.id,n)}),enabled:!!(a!=null&&a.id)&&["select","multiselect"].includes(a.field_type)&&!E,getOptions:o=>o.values,queryKey:["rule-value-options",F,a==null?void 0:a.id]}),V=z({control:d.control,name:b});return e.jsx(i.Field,{name:j,render:({field:{onChange:o,ref:h,...v}})=>(a==null?void 0:a.field_type)==="number"?e.jsxs(i.Item,{className:"basis-1/2",children:[e.jsx(i.Control,{children:e.jsx(K,{...v,type:"number",onChange:o,className:"bg-ui-bg-base",ref:h,min:1,disabled:!r.attribute})}),e.jsx(i.ErrorMessage,{})]}):(a==null?void 0:a.field_type)==="text"?e.jsxs(i.Item,{className:"basis-1/2",children:[e.jsx(i.Control,{children:e.jsx(K,{...v,ref:h,onChange:o,className:"bg-ui-bg-base",disabled:!r.attribute})}),e.jsx(i.ErrorMessage,{})]}):e.jsxs(i.Item,{className:"basis-1/2",children:[e.jsx(i.Control,{children:e.jsx(Q,{...v,...C,multiple:V!=="eq",ref:h,placeholder:V==="eq"?"Select Value":"Select Values",onChange:o})}),e.jsx(i.ErrorMessage,{})]})},`${s}.${u}.${j}-${r.attribute}`)},W={id:"product",attribute:"items.product.id",attribute_label:"Product",operator:"eq",operator_label:"Equal",values:[],required:!0,field_type:"select",disguised:!1},be=({form:d,ruleType:s,setRulesToRemove:u,rulesToRemove:j,scope:b="rules",promotion:r})=>{var L;const{t:m}=U(),F=d.getValues(),{attributes:a}=Z(s,F.type),{fields:n,append:E,remove:C,update:V,replace:o}=T({control:d.control,name:b,keyName:b}),h=z({control:d.control,name:"type",defaultValue:r==null?void 0:r.type}),v=z({control:d.control,name:"application_method.type",defaultValue:(L=r==null?void 0:r.application_method)==null?void 0:L.type}),Y=h?{promotion_type:h,application_method_type:v}:{},{rules:f,isLoading:B}=O((r==null?void 0:r.id)||null,s,Y,{enabled:!!(r!=null&&r.id)||!!h&&!!v});return D.useEffect(()=>{if(!B){if(s==="rules"&&!n.length&&(d.resetField("rules"),o(P(f))),s==="buy-rules"&&!n.length){d.resetField("application_method.buy_rules");const t=r!=null&&r.id||h==="standard"?f:[...f,W];o(P(t))}if(s==="target-rules"&&!n.length){d.resetField("application_method.target_rules");const t=r!=null&&r.id||h==="standard"?f:[...f,W];o(P(t))}}},[h,B,s,n.length,d,o,f,r==null?void 0:r.id]),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(R,{level:"h2",className:"mb-2",children:m(`promotions.fields.conditions.${s}.title`)}),e.jsx(ee,{className:"text-ui-fg-subtle txt-small mb-6",children:m(`promotions.fields.conditions.${s}.description`)}),n.map((t,x)=>{const y=t.id;return e.jsxs(D.Fragment,{children:[e.jsxs("div",{className:"bg-ui-bg-subtle border-ui-border-base flex flex-row gap-2 rounded-xl border px-2 py-2",children:[e.jsxs("div",{className:"grow",children:[e.jsx(i.Field,{name:`${b}.${x}.attribute`,render:({field:N})=>{var q;const{onChange:w,ref:M,...k}=N,_=(n==null?void 0:n.map(l=>l.attribute))||[],c=(a==null?void 0:a.filter(l=>l.value===t.attribute?!0:!_.includes(l.value)))||[],S=!!t.required,I=l=>{var H;const g=c.find(G=>G.id===l),$={...t,disguised:(g==null?void 0:g.disguised)||!1};((H=g==null?void 0:g.operators)==null?void 0:H.length)===1&&($.operator=g.operators[0].value),$.operator==="eq"?$.values="":$.values=[],V(x,$),w(l)};return e.jsxs(i.Item,{className:"mb-2",children:[t.required&&e.jsx("div",{className:"flex items-center px-2",children:e.jsx("p",{className:"text text-ui-fg-muted txt-small",children:m("promotions.form.required")})}),e.jsx(i.Control,{children:S?e.jsx(A,{label:((q=c==null?void 0:c.find(l=>l.value===t.attribute))==null?void 0:q.label)||"",field:N}):e.jsxs(p,{...k,onValueChange:I,disabled:t.required,children:[e.jsx(p.Trigger,{ref:M,className:"bg-ui-bg-base",children:e.jsx(p.Value,{placeholder:m("promotions.form.selectAttribute")})}),e.jsx(p.Content,{children:c==null?void 0:c.map((l,g)=>e.jsx(p.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},`${y}-attribute-option-${g}`))})]})}),e.jsx(i.ErrorMessage,{})]})}}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i.Field,{name:`${b}.${x}.operator`,render:({field:N})=>{var I,q;const{onChange:w,ref:M,...k}=N,_=a==null?void 0:a.find(l=>l.value===t.attribute),c=((I=_==null?void 0:_.operators)==null?void 0:I.map((l,g)=>({label:l.label,value:l.value,key:`${y}-operator-option-${g}`})))||[],S=!!t.attribute&&(c==null?void 0:c.length)<=1;return e.jsxs(i.Item,{className:"basis-1/2",children:[e.jsx(i.Control,{children:S?e.jsx(A,{label:((q=c.find(l=>l.value===k.value))==null?void 0:q.label)||"",field:N}):e.jsxs(p,{...k,disabled:!t.attribute,onValueChange:w,children:[e.jsx(p.Trigger,{ref:M,className:"bg-ui-bg-base",children:e.jsx(p.Value,{placeholder:"Select Operator"})}),e.jsx(p.Content,{children:c==null?void 0:c.map(l=>e.jsx(p.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},l.key))})]})}),e.jsx(i.ErrorMessage,{})]})}}),e.jsx(ie,{form:d,identifier:y,scope:b,name:`${b}.${x}.values`,operator:`${b}.${x}.operator`,fieldRule:t,attributes:a,ruleType:s})]})]}),e.jsx("div",{className:"size-7 flex-none self-center",children:!t.required&&e.jsx(se,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:()=>{t.required||(u&&u([...j,t]),C(x))},children:e.jsx(te,{})})})]}),x<n.length-1&&e.jsxs("div",{className:"relative px-6 py-3",children:[e.jsx("div",{className:"border-ui-border-strong absolute bottom-0 left-[40px] top-0 z-[-1] w-px bg-[linear-gradient(var(--border-strong)_33%,rgba(255,255,255,0)_0%)] bg-[length:1px_3px] bg-repeat-y"}),e.jsx(ae,{size:"2xsmall",className:" text-xs",children:m("promotions.form.and")})]})]},`${t.id}.${x}.${t.attribute}`)}),e.jsxs("div",{className:n.length?"mt-6":"",children:[e.jsx(X,{type:"button",variant:"secondary",className:"inline-block",onClick:()=>{E({attribute:"",operator:"",values:[],required:!1})},children:m("promotions.fields.addCondition")}),!!n.length&&e.jsx(X,{type:"button",variant:"transparent",className:"text-ui-fg-muted hover:text-ui-fg-subtle ml-2 inline-block",onClick:()=>{const t=n.map((x,y)=>x.required?null:y).filter(x=>x!==null);u&&u(n.filter(x=>!x.required)),C(t)},children:m("promotions.fields.clearAll")})]})]})},A=D.forwardRef(({label:d,field:s},u)=>e.jsxs("div",{children:[e.jsx("div",{className:"txt-compact-small bg-ui-bg-component shadow-borders-base text-ui-fg-base h-8 rounded-md px-2 py-1.5",children:d}),e.jsx("input",{...s,ref:u,disabled:!0,hidden:!0})]}));A.displayName="DisabledField";export{be as R};
