import{u as Z}from"./chunk-HFB3OQXI-B00MlUDe.js";import{C as O}from"./chunk-2PMSBTXI-BwxFu_r2.js";import{r as A,j as e,b as T,ds as R,E as ee,x as I,dt as se,H as ae,G as te,y as d,ai as p,I as le,M as re,a6 as ie,B as X,i as de,s as ne,z as J}from"./index-BfncdA6x.js";var D=i=>(i||[]).map(s=>{var o,h;return{id:s.id,required:s.required,field_type:s.field_type,disguised:s.disguised,attribute:s.attribute,operator:s.operator,values:s.field_type==="number"||s.operator==="eq"?typeof s.values=="object"?(o=s.values[0])==null?void 0:o.value:s.values:(h=s==null?void 0:s.values)==null?void 0:h.map(x=>x.value)}}),ce=(i,s)=>{var o;return!i||!s?{}:i==="currency_code"?{value:(o=s.supported_currencies)==null?void 0:o.map(h=>h.currency_code)}:{}},oe=({form:i,identifier:s,scope:o,name:h,operator:x,fieldRule:t,attributes:b,ruleType:y,applicationMethodTargetType:m})=>{const a=b==null?void 0:b.find(n=>n.value===t.attribute),{store:M,isLoading:V}=de(),w=Z({queryFn:async n=>await ne.admin.promotion.listRuleValues(y,a==null?void 0:a.id,{...n,...ce(a==null?void 0:a.id,M),application_method_target_type:m}),enabled:!!(a!=null&&a.id)&&["select","multiselect"].includes(a.field_type)&&!V,getOptions:n=>n.values,queryKey:["rule-value-options",y,a==null?void 0:a.id]}),v=I({control:i.control,name:x});return e.jsx(d.Field,{name:h,render:({field:{onChange:n,ref:f,...j}})=>(a==null?void 0:a.field_type)==="number"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(J,{...j,type:"number",onChange:n,className:"bg-ui-bg-base",ref:f,min:1,disabled:!t.attribute})}),e.jsx(d.ErrorMessage,{})]}):(a==null?void 0:a.field_type)==="text"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(J,{...j,ref:f,onChange:n,className:"bg-ui-bg-base",disabled:!t.attribute})}),e.jsx(d.ErrorMessage,{})]}):e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(O,{...j,...w,multiple:v!=="eq",ref:f,placeholder:v==="eq"?"Select Value":"Select Values",onChange:n})}),e.jsx(d.ErrorMessage,{})]})},`${s}.${o}.${h}-${t.attribute}`)},Q={id:"product",attribute:"items.product.id",attribute_label:"Product",operator:"eq",operator_label:"Equal",values:[],required:!0,field_type:"select",disguised:!1},ge=({form:i,ruleType:s,setRulesToRemove:o,rulesToRemove:h,scope:x="rules",promotion:t})=>{var H,G,K;const{t:b}=T(),y=i.getValues(),{attributes:m}=R(s,y.type,(H=y.application_method)==null?void 0:H.target_type),{fields:a,append:M,remove:V,update:w,replace:v}=ee({control:i.control,name:x,keyName:x}),n=I({control:i.control,name:"type",defaultValue:t==null?void 0:t.type}),f=I({control:i.control,name:"application_method.type",defaultValue:(G=t==null?void 0:t.application_method)==null?void 0:G.type}),j=I({control:i.control,name:"application_method.target_type",defaultValue:(K=t==null?void 0:t.application_method)==null?void 0:K.target_type}),U=n?{promotion_type:n,application_method_type:f,application_method_target_type:j}:{},{rules:_,isLoading:L}=se((t==null?void 0:t.id)||null,s,U,{enabled:!!(t!=null&&t.id)||!!n&&!!f});return A.useEffect(()=>{if(!L){if(s==="rules"&&!a.length&&(i.resetField("rules"),v(D(_))),s==="buy-rules"&&!a.length){i.resetField("application_method.buy_rules");const r=t!=null&&t.id||n==="standard"?_:[..._,Q];v(D(r))}if(s==="target-rules"&&!a.length){i.resetField("application_method.target_rules");const r=t!=null&&t.id||n==="standard"?_:[..._,Q];v(D(r))}}},[n,L,s,a.length,i,v,_,t==null?void 0:t.id]),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(ae,{level:"h2",className:"mb-2",children:b(s==="target-rules"?`promotions.fields.conditions.${s}.${j}.title`:`promotions.fields.conditions.${s}.title`)}),e.jsx(te,{className:"text-ui-fg-subtle txt-small mb-6",children:b(s==="target-rules"?`promotions.fields.conditions.${s}.${j}.description`:`promotions.fields.conditions.${s}.description`)}),a.map((r,u)=>{const N=r.id;return e.jsxs(A.Fragment,{children:[e.jsxs("div",{className:"bg-ui-bg-subtle border-ui-border-base flex flex-row gap-2 rounded-xl border px-2 py-2",children:[e.jsxs("div",{className:"grow",children:[e.jsx(d.Field,{name:`${x}.${u}.attribute`,render:({field:$})=>{var F;const{onChange:P,ref:S,...k}=$,q=(a==null?void 0:a.map(l=>l.attribute))||[],c=(m==null?void 0:m.filter(l=>l.value===r.attribute?!0:!q.includes(l.value)))||[],z=!!r.required,E=l=>{var W;const g=c.find(Y=>Y.id===l),C={...r,disguised:(g==null?void 0:g.disguised)||!1};((W=g==null?void 0:g.operators)==null?void 0:W.length)===1&&(C.operator=g.operators[0].value),C.operator==="eq"?C.values="":C.values=[],w(u,C),P(l)};return e.jsxs(d.Item,{className:"mb-2",children:[r.required&&e.jsx("div",{className:"flex items-center px-2",children:e.jsx("p",{className:"text text-ui-fg-muted txt-small",children:b("promotions.form.required")})}),e.jsx(d.Control,{children:z?e.jsx(B,{label:((F=c==null?void 0:c.find(l=>l.value===r.attribute))==null?void 0:F.label)||"",field:$}):e.jsxs(p,{...k,onValueChange:E,disabled:r.required,children:[e.jsx(p.Trigger,{ref:S,className:"bg-ui-bg-base",children:e.jsx(p.Value,{placeholder:b("promotions.form.selectAttribute")})}),e.jsx(p.Content,{children:c==null?void 0:c.map((l,g)=>e.jsx(p.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},`${N}-attribute-option-${g}`))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d.Field,{name:`${x}.${u}.operator`,render:({field:$})=>{var E,F;const{onChange:P,ref:S,...k}=$,q=m==null?void 0:m.find(l=>l.value===r.attribute),c=((E=q==null?void 0:q.operators)==null?void 0:E.map((l,g)=>({label:l.label,value:l.value,key:`${N}-operator-option-${g}`})))||[],z=!!r.attribute&&(c==null?void 0:c.length)<=1;return e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:z?e.jsx(B,{label:((F=c.find(l=>l.value===k.value))==null?void 0:F.label)||"",field:$}):e.jsxs(p,{...k,disabled:!r.attribute,onValueChange:P,children:[e.jsx(p.Trigger,{ref:S,className:"bg-ui-bg-base",children:e.jsx(p.Value,{placeholder:"Select Operator"})}),e.jsx(p.Content,{children:c==null?void 0:c.map(l=>e.jsx(p.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},l.key))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsx(oe,{form:i,identifier:N,scope:x,name:`${x}.${u}.values`,operator:`${x}.${u}.operator`,fieldRule:r,attributes:m,ruleType:s,applicationMethodTargetType:j})]})]}),e.jsx("div",{className:"size-7 flex-none self-center",children:!r.required&&e.jsx(le,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:()=>{r.required||(o&&o([...h,r]),V(u))},children:e.jsx(re,{})})})]}),u<a.length-1&&e.jsxs("div",{className:"relative px-6 py-3",children:[e.jsx("div",{className:"border-ui-border-strong absolute bottom-0 left-[40px] top-0 z-[-1] w-px bg-[linear-gradient(var(--border-strong)_33%,rgba(255,255,255,0)_0%)] bg-[length:1px_3px] bg-repeat-y"}),e.jsx(ie,{size:"2xsmall",className:" text-xs",children:b("promotions.form.and")})]})]},`${r.id}.${u}.${r.attribute}`)}),e.jsxs("div",{className:a.length?"mt-6":"",children:[e.jsx(X,{type:"button",variant:"secondary",className:"inline-block",onClick:()=>{M({attribute:"",operator:"",values:[],required:!1})},children:b("promotions.fields.addCondition")}),!!a.length&&e.jsx(X,{type:"button",variant:"transparent",className:"text-ui-fg-muted hover:text-ui-fg-subtle ml-2 inline-block",onClick:()=>{const r=a.map((u,N)=>u.required?null:N).filter(u=>u!==null);o&&o(a.filter(u=>!u.required)),V(r)},children:b("promotions.fields.clearAll")})]})]})},B=A.forwardRef(({label:i,field:s},o)=>e.jsxs("div",{children:[e.jsx("div",{className:"txt-compact-small bg-ui-bg-component shadow-borders-base text-ui-fg-base h-8 rounded-md px-2 py-1.5",children:i}),e.jsx("input",{...s,ref:o,disabled:!0,hidden:!0})]}));B.displayName="DisabledField";export{ge as R};
